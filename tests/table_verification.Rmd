---
title: "Table verification"
---

```{r}
library(dplyr)
library(tidyselect)
library(stringr)
library(tidyr)
library(xml2)
library(rlang)
library(cli)
library(purrr)
```

```{r}

A <- "HLA-A*02:01"
B <- "HLA-A*68:01"
C <- "HLA-A*24:02"
D <- "HLA-A*69:01"
N <- "HLA-A*01:11N"
b <- "bidirectional"

join <- function(a, b) {
  return(paste0(a, "+", b))
}

```

```{r}

cat("\n\nSECTION 1\n")

identical(HLA_mismatch_number(join(A, B), join(A, B), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(A, B), join(A, B), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(A, B), join(A, B), "HLA-A", b), 0L)

identical(HLA_mismatch_number(join(A, A), join(A, A), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(A, A), join(A, A), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(A, A), join(A, A), "HLA-A", b), 0L)

identical(HLA_mismatch_number(join(A, A), join(N, A), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(A, A), join(N, A), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(A, A), join(N, A), "HLA-A", b), 0L)

identical(HLA_mismatch_number(join(N, A), join(A, A), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(N, A), join(A, A), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(N, A), join(A, A), "HLA-A", b), 0L)

identical(HLA_mismatch_number(join(N, A), join(N, A), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(N, A), join(N, A), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(N, A), join(N, A), "HLA-A", b), 0L)

identical(HLA_mismatch_number(join(N, N), join(N, N), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(N, N), join(N, N), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(N, N), join(N, N), "HLA-A", b), 0L)


cat("\n\nSECTION 2\n")


identical(HLA_mismatch_number(join(A, A), join(A, B), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(A, A), join(A, B), "HLA-A", "HvG"), 1L) #
identical(HLA_mismatch_number(join(A, A), join(A, B), "HLA-A", b), 1L)

identical(HLA_mismatch_number(join(N, A), join(A, B), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(N, A), join(A, B), "HLA-A", "HvG"), 1L) #
identical(HLA_mismatch_number(join(N, A), join(A, B), "HLA-A", b), 1L)

identical(HLA_mismatch_number(join(N, N), join(N, A), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(N, N), join(N, A), "HLA-A", "HvG"), 1L)#
identical(HLA_mismatch_number(join(N, N), join(N, A), "HLA-A", b), 1L)


cat("\n\nSECTION 3\n")


identical(HLA_mismatch_number(join(A, B), join(A, A), "HLA-A", "GvH"), 1L) #
identical(HLA_mismatch_number(join(A, B), join(A, A), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(A, B), join(A, A), "HLA-A", b), 1L)

identical(HLA_mismatch_number(join(A, B), join(N, A), "HLA-A", "GvH"), 1L) #
identical(HLA_mismatch_number(join(A, B), join(N, A), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(A, B), join(N, A), "HLA-A", b), 1L)

identical(HLA_mismatch_number(join(N, A), join(N, N), "HLA-A", "GvH"), 1L) #
identical(HLA_mismatch_number(join(N, A), join(N, N), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(N, A), join(N, N), "HLA-A", b), 1L)


cat("\n\nSECTION 4\n")


identical(HLA_mismatch_number(join(A, B), join(A, C), "HLA-A", "GvH"), 1L)
identical(HLA_mismatch_number(join(A, B), join(A, C), "HLA-A", "HvG"), 1L)
identical(HLA_mismatch_number(join(A, B), join(A, C), "HLA-A", b), 1L)

identical(HLA_mismatch_number(join(N, A), join(N, B), "HLA-A", "GvH"), 1L)
identical(HLA_mismatch_number(join(N, A), join(N, B), "HLA-A", "HvG"), 1L)
identical(HLA_mismatch_number(join(N, A), join(N, B), "HLA-A", b), 1L)


cat("\n\nSECTION 5\n")


identical(HLA_mismatch_number(join(N, N), join(A, A), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(N, N), join(A, A), "HLA-A", "HvG"), 2L)
identical(HLA_mismatch_number(join(N, N), join(A, A), "HLA-A", b), 2L)

identical(HLA_mismatch_number(join(N, N), join(A, B), "HLA-A", "GvH"), 0L)
identical(HLA_mismatch_number(join(N, N), join(A, B), "HLA-A", "HvG"), 2L)
identical(HLA_mismatch_number(join(N, N), join(A, B), "HLA-A", b), 2L)


cat("\n\nSECTION 6\n")


identical(HLA_mismatch_number(join(A, A), join(N, N), "HLA-A", "GvH"), 2L)
identical(HLA_mismatch_number(join(A, A), join(N, N), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(A, A), join(N, N), "HLA-A", b), 2L)

identical(HLA_mismatch_number(join(A, B), join(N, N), "HLA-A", "GvH"), 2L)
identical(HLA_mismatch_number(join(A, B), join(N, N), "HLA-A", "HvG"), 0L)
identical(HLA_mismatch_number(join(A, B), join(N, N), "HLA-A", b), 2L)



cat("\n\nSECTION 7\n")



identical(HLA_mismatch_number(join(A, A), join(B, B), "HLA-A", "GvH"), 2L)
identical(HLA_mismatch_number(join(A, A), join(B, B), "HLA-A", "HvG"), 2L)
identical(HLA_mismatch_number(join(A, A), join(B, B), "HLA-A", b), 2L)

identical(HLA_mismatch_number(join(A, A), join(N, B), "HLA-A", "GvH"), 2L)
########################################################################################################################
identical(HLA_mismatch_number(join(A, A), join(N, B), "HLA-A", "HvG"), 2L) 
print(HLA_mismatch_number(join(A, A), join(N, B), "HLA-A", "HvG"))
########################################################################################################################
identical(HLA_mismatch_number(join(A, A), join(N, B), "HLA-A", b), 2L)

########################################################################################################################
identical(HLA_mismatch_number(join(N, A), join(B, B), "HLA-A", "GvH"), 2L) 
print(HLA_mismatch_number(join(N, A), join(B, B), "HLA-A", "GvH"))
########################################################################################################################
identical(HLA_mismatch_number(join(N, A), join(B, B), "HLA-A", "HvG"), 2L)
identical(HLA_mismatch_number(join(N, A), join(B, B), "HLA-A", b), 2L)



cat("\n\nSECTION 8\n")



identical(HLA_mismatch_number(join(A, A), join(B, C), "HLA-A", "GvH"), 2L)
identical(HLA_mismatch_number(join(A, A), join(B, C), "HLA-A", "HvG"), 2L)
identical(HLA_mismatch_number(join(A, A), join(B, C), "HLA-A", b), 2L)

########################################################################################################################
identical(HLA_mismatch_number(join(N, A), join(B, C), "HLA-A", "GvH"), 2L) 
print(HLA_mismatch_number(join(N, A), join(B, C), "HLA-A", "GvH"))
########################################################################################################################
identical(HLA_mismatch_number(join(N, A), join(B, C), "HLA-A", "HvG"), 2L)
identical(HLA_mismatch_number(join(N, A), join(B, C), "HLA-A", b), 2L)

identical(HLA_mismatch_number(join(A, B), join(C, C), "HLA-A", "GvH"), 2L)
identical(HLA_mismatch_number(join(A, B), join(C, C), "HLA-A", "HvG"), 2L)
identical(HLA_mismatch_number(join(A, B), join(C, C), "HLA-A", b), 2L)

identical(HLA_mismatch_number(join(A, B), join(N, C), "HLA-A", "GvH"), 2L)
########################################################################################################################
identical(HLA_mismatch_number(join(A, B), join(N, C), "HLA-A", "HvG"), 2L) 
print(HLA_mismatch_number(join(A, B), join(N, C), "HLA-A", "HvG"))
########################################################################################################################
identical(HLA_mismatch_number(join(A, B), join(N, C), "HLA-A", b), 2L)

identical(HLA_mismatch_number(join(A, B), join(C, D), "HLA-A", "GvH"), 2L)
identical(HLA_mismatch_number(join(A, B), join(C, D), "HLA-A", "HvG"), 2L)
identical(HLA_mismatch_number(join(A, B), join(C, D), "HLA-A", b), 2L)


```

```{r}
HLA_mismatch_number("HLA-A*02:01+HLA-A*02:01", "HLA-A*02:99N+HLA-A*68:01", "HLA-A", "HvG")
HLA_mismatch_number("HLA-A*02:99N+HLA-A*02:01", "HLA-A*68:01+HLA-A*68:01", "HLA-A", "HvG")
HLA_mismatch_number("HLA-A*02:99N+HLA-A*02:01", "HLA-A*68:01+HLA-A*24:02", "HLA-A", "HvG")
HLA_mismatch_number("HLA-A*02:01+HLA-A*68:01", "HLA-A*02:99N+HLA-A*24:02", "HLA-A", "HvG")

HLA_mismatch_base("HLA-A*01:11N+HLA-A*01:11N", "HLA-A*01:11N+HLA-A*02:01", "HLA-A", "HvG")

identical(HLA_mismatch_number(join(N, N), join(N, A), "HLA-A", "HvG"), 1L)#
identical(HLA_mismatch_number(join(N, N), join(N, A), "HLA-A", b), 1L)
```

```{r}
# Function to preprocess GL strings: handle null alleles and homozygosity
  preprocess_GL_string <- function(GL_string, homozygous_count) {
    # Split GL string into alleles
    alleles <- str_split(GL_string, "\\+", simplify = TRUE)
    
    # Handle homozygosity
    if (length(alleles) == 1 && homozygous_count == 2) {
      alleles <- rep(alleles, times = homozygous_count)
    }
    
    # Remove null alleles
    non_null_alleles <- alleles[!str_detect(alleles, "[Nn]$")]
    
    # Filter out empty strings resulting from removal of null alleles
    non_null_alleles <- non_null_alleles[non_null_alleles != ""]
    
    # Return processed alleles as a single GL string
    #return(str_c(non_null_alleles, collapse = "+"))
    return(non_null_alleles)
  }

preprocess_GL_string("HLA-A*01:11N+HLA-A*01:11N", 2)
```


1.	HLA_mismatch_number(join(A, A), join(N, B), "HLA-A", "HvG")
2.	HLA_mismatch_number(join(N, A), join(B, B), "HLA-A", "GvH")
3.	HLA_mismatch_number(join(N, A), join(B, C), "HLA-A", "GvH")
4.	HLA_mismatch_number(join(A, B), join(N, C), "HLA-A", "HvG")

A <- "HLA-A*02:01"
B <- "HLA-A*68:01"
C <- "HLA-A*24:02"
D <- "HLA-A*69:01"
N <- "HLA-A*02:99N"
